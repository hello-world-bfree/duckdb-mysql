# name: test/sql/federation_benchmark_profile.test
# description: Profile-based benchmark to measure federation optimizer effectiveness
# group: [sql]

#
# This test creates a large table and runs queries with profiling enabled
# to measure the actual performance impact of filter pushdown.
#
# Expected improvements:
# - Point lookup (0.01%): 10-100x speedup
# - Indexed range (1%): 5-20x speedup
# - Medium selectivity (10%): 2-5x speedup
# - High selectivity (50%+): minimal improvement
#
# Run with: build/debug/test/unittest --test-dir test/sql "federation_benchmark_profile"

require mysql_scanner

require-env MYSQL_TEST_DATABASE_AVAILABLE

# ============================================================================
# SETUP
# ============================================================================

statement ok
ATTACH 'host=localhost user=root port=3306 database=mysqlscanner' AS bench (TYPE MYSQL_SCANNER)

statement ok
DROP TABLE IF EXISTS bench.perf_test

statement ok
CREATE TABLE bench.perf_test (
    id INTEGER PRIMARY KEY,
    indexed_col INTEGER,
    string_col VARCHAR(50),
    data_col VARCHAR(200)
)

statement ok
CREATE INDEX idx_perf_indexed ON bench.perf_test(indexed_col)

# Insert 10000 rows
statement ok
INSERT INTO bench.perf_test
SELECT
    i,
    i % 100,
    CASE WHEN i % 5 = 0 THEN 'alpha'
         WHEN i % 5 = 1 THEN 'beta'
         WHEN i % 5 = 2 THEN 'gamma'
         WHEN i % 5 = 3 THEN 'delta'
         ELSE 'epsilon' END,
    CONCAT('Row data payload for record number ', CAST(i AS VARCHAR), ' with extra padding')
FROM generate_series(1, 10000) AS t(i)

# ============================================================================
# TEST 1: Baseline - Full Table Scan (no filter)
# Establishes baseline transfer time for 10000 rows
# ============================================================================

query I
SELECT COUNT(*) FROM bench.perf_test
----
10000

# ============================================================================
# TEST 2: Point Lookup - Maximum Pushdown Benefit
# Selectivity: 0.01% (1 row out of 10000)
# Expected: Near-instant with pushdown, slow without
# ============================================================================

statement ok
SET GLOBAL mysql_experimental_filter_pushdown=true

query II
SELECT id, indexed_col FROM bench.perf_test WHERE id = 5000
----
5000	0

# Verify the row exists
query I
SELECT COUNT(*) FROM bench.perf_test WHERE id = 5000
----
1

# ============================================================================
# TEST 3: Indexed Column Equality - High Benefit
# Selectivity: 1% (100 rows out of 10000)
# indexed_col = 50 matches ids: 50, 150, 250, ..., 9950
# ============================================================================

query I
SELECT COUNT(*) FROM bench.perf_test WHERE indexed_col = 50
----
100

# Verify distribution
query I
SELECT MIN(id) FROM bench.perf_test WHERE indexed_col = 50
----
50

query I
SELECT MAX(id) FROM bench.perf_test WHERE indexed_col = 50
----
9950

# ============================================================================
# TEST 4: IN Filter - Medium Benefit
# Selectivity: 5% (500 rows)
# ============================================================================

query I
SELECT COUNT(*) FROM bench.perf_test
WHERE indexed_col IN (10, 20, 30, 40, 50)
----
500

# ============================================================================
# TEST 5: Range Filter - Medium Benefit
# Selectivity: 10% (1000 rows)
# ============================================================================

query I
SELECT COUNT(*) FROM bench.perf_test
WHERE id BETWEEN 1 AND 1000
----
1000

# ============================================================================
# TEST 6: String Equality - Medium Benefit
# Selectivity: 20% (2000 rows)
# ============================================================================

query I
SELECT COUNT(*) FROM bench.perf_test
WHERE string_col = 'alpha'
----
2000

# ============================================================================
# TEST 7: Hybrid Execution - Indexed + Function
# indexed_col = 25 (100 rows) AND LENGTH(data_col) > 50
# All data_col values are ~60 chars, so all 100 should match
# ============================================================================

query I
SELECT COUNT(*) FROM bench.perf_test
WHERE indexed_col = 25
  AND LENGTH(data_col) > 50
----
100

# Test with stricter local filter
query I
SELECT COUNT(*) FROM bench.perf_test
WHERE indexed_col = 25
  AND LENGTH(data_col) > 60
----
0

# ============================================================================
# TEST 8: Multiple Hybrid Filters
# indexed_col = 10 AND MOD(id, 7) = 0 AND LENGTH(string_col) = 5
# indexed_col = 10 matches: 10, 110, 210, ..., 9910 (100 rows)
# MOD(id, 7) = 0 from those: 210, 910, 1610, 2310, 3010, 3710, 4410, 5110, 5810, 6510, 7210, 7910, 8610, 9310 (14 rows)
# All string_col values are 5 chars (alpha/beta/gamma/delta/epsilon)
# Wait - epsilon is 7 chars, others are 4-5
# ============================================================================

query I
SELECT COUNT(*) FROM bench.perf_test
WHERE indexed_col = 10
  AND MOD(id, 7) = 0
----
14

# ============================================================================
# TEST 9: Low Selectivity - Should Prefer Local Execution
# indexed_col > 0 matches 99% of rows
# Cost model should choose LOCAL_ALL or PUSH_ALL (not HYBRID)
# ============================================================================

query I
SELECT COUNT(*) FROM bench.perf_test
WHERE indexed_col > 0
----
9900

# ============================================================================
# TEST 10: Aggregation with Selective Filter
# Tests that pushdown benefits aggregation queries
# ============================================================================

query I
SELECT SUM(indexed_col) FROM bench.perf_test
WHERE indexed_col = 75
----
7500

query I
SELECT AVG(id) FROM bench.perf_test
WHERE indexed_col = 75
----
5025.0

# ============================================================================
# TEST 11: Comparison - With vs Without Pushdown
# Run same query with pushdown enabled and disabled
# Results should be identical (correctness check)
# ============================================================================

statement ok
SET GLOBAL mysql_experimental_filter_pushdown=true

query I
SELECT COUNT(*) FROM bench.perf_test
WHERE indexed_col = 33 AND LENGTH(data_col) > 40
----
100

statement ok
SET GLOBAL mysql_experimental_filter_pushdown=false

query I
SELECT COUNT(*) FROM bench.perf_test
WHERE indexed_col = 33 AND LENGTH(data_col) > 40
----
100

# Re-enable for remaining tests
statement ok
SET GLOBAL mysql_experimental_filter_pushdown=true

# ============================================================================
# TEST 12: Edge Case - Empty Result from Pushed Filter
# indexed_col = 999 matches 0 rows
# ============================================================================

query I
SELECT COUNT(*) FROM bench.perf_test
WHERE indexed_col = 999
  AND LENGTH(data_col) < 10
----
0

# ============================================================================
# TEST 13: Edge Case - All Rows Match Pushed Filter
# indexed_col >= 0 matches all rows
# Local filter does heavy lifting
# ============================================================================

query I
SELECT COUNT(*) FROM bench.perf_test
WHERE indexed_col >= 0
  AND MOD(id, 500) = 1
----
20

# ============================================================================
# CLEANUP
# ============================================================================

statement ok
DROP TABLE bench.perf_test
